---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const posts = allPosts.filter((post) => import.meta.env.DEV || !post.data.localOnly);
  const uniqueTags = [...new Set(posts.map((post) => post.data.tags).flat())];
  return uniqueTags.map((tag) => {
    const filteredPosts = posts.filter((post) => post.data.tags.includes(tag))
      .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout title={`#${tag}`} description={`Posts tagged with ${tag}`}>
	<Header slot="header" />
	
  <div class="mt-8">
    <h1 class="text-3xl font-bold mb-8 font-serif text-center">#{tag}</h1>
    <ul class="space-y-10">
      {posts.map((post) => (
        <li class="group">
          <a href={`/posts/${post.slug}/`} class="block focus:outline-none">
            <div class="flex flex-col sm:flex-row sm:items-baseline justify-between gap-2 sm:gap-4">
              <h3 class="text-lg md:text-xl font-bold text-zinc-900 dark:text-zinc-100 group-hover:opacity-70 transition-opacity font-serif leading-snug">
                {post.data.title}
              </h3>
              <time datetime={post.data.pubDate.toISOString()} class="text-xs sm:text-sm text-zinc-400 dark:text-zinc-500 font-mono whitespace-nowrap shrink-0">
                {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' })}
              </time>
            </div>
            {post.data.description && (
              <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-400 line-clamp-2 leading-relaxed">
                {post.data.description}
              </p>
            )}
          </a>
        </li>
      ))}
    </ul>
    <div class="text-center mt-12">
      <a href="/tags/" class="text-sm text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300">View all tags</a>
    </div>
  </div>

	<Footer slot="footer" />
</BaseLayout>
